<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Events | Actify</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="css/events.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>

<body>
    <!-- Navigation -->
    <nav class="nav-logged-in">
        <div class="nav-container">
            <a href="dashboard.html" class="nav-brand">
                <div class="brand-icon-small">
                    <i data-lucide="heart" class="icon-filled"></i>
                </div>
                <span class="brand-name">Actify</span>
            </a>

            <div class="nav-links-main">
                <a href="dashboard.html" class="nav-link">
                    <i data-lucide="heart"></i>
                    Dashboard
                </a>
                <a href="events.html" class="nav-link active">
                    <i data-lucide="calendar"></i>
                    Events
                </a>
                <a href="rewards.html" class="nav-link">
                    <i data-lucide="gift"></i>
                    Rewards
                </a>
                <a href="leaderboard.html" class="nav-link">
                    <i data-lucide="trophy"></i>
                    Leaderboard
                </a>
                <a href="badges.html" class="nav-link">
                    <i data-lucide="award"></i>
                    Badges
                </a>
            </div>

            <div class="nav-user">
                <div class="user-coins">
                    <span class="coin-value">0</span>
                </div>
                <span class="coin-icon">ü™ô</span>
                <a href="profile.html" style="text-decoration: none;">
                    <div class="user-avatar" style="cursor: pointer;">A</div>
                </a>
                <button onclick="logout()" class="logout-btn" title="Logout">
                    <i data-lucide="log-out"></i>
                </button>
            </div>
        </div>

        <!-- Mobile Navigation -->
        <div class="nav-mobile">
            <a href="dashboard.html" class="nav-mobile-item">
                <i data-lucide="heart"></i>
                <span>Dashboard</span>
            </a>
            <a href="events.html" class="nav-mobile-item active">
                <i data-lucide="map-pin"></i>
                <span>Events</span>
            </a>
            <a href="rewards.html" class="nav-mobile-item">
                <i data-lucide="gift"></i>
                <span>Rewards</span>
            </a>
            <a href="leaderboard.html" class="nav-mobile-item">
                <i data-lucide="trophy"></i>
                <span>Leaderboard</span>
            </a>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-container">
        <!-- Page Header -->
        <div class="page-header">
            <h1 class="page-title">Discover Volunteer Events</h1>
            <p class="page-subtitle">Find nearby opportunities that match your interests</p>
        </div>

        <!-- View Toggle -->
        <div class="view-toggle">
            <button class="btn btn-sm btn-primary" id="gridViewBtn">
                <i data-lucide="grid-3x3" style="width:16px;height:16px;margin-right:4px;"></i>
                Grid View
            </button>
            <button class="btn btn-sm btn-outline" id="mapViewBtn">
                <i data-lucide="map" style="width:16px;height:16px;margin-right:4px;"></i>
                Map View
            </button>
        </div>

        <!-- Filter by Cause -->
        <div class="filter-bar">
            <button class="filter-btn active" data-cause="All">All</button>
            <button class="filter-btn" data-cause="Environment">Environment</button>
            <button class="filter-btn" data-cause="Education">Education</button>
            <button class="filter-btn" data-cause="Charity">Charity</button>
            <button class="filter-btn" data-cause="Health">Health</button>
        </div>

        <!-- Nearby Events Alert (shown when location is enabled) -->
        <div class="nearby-events-section" id="nearbyAlert">
            <h3>
                <i data-lucide="map-pin" style="width:18px;height:18px;"></i>
                Events Near You
                <span class="nearby-count" id="nearbyCount">0</span>
            </h3>
            <p style="font-size: 0.85rem; color: #78350f;" id="nearbyText">No events found within selected radius</p>
        </div>

        <!-- Enhanced Map Section -->
        <div id="mapView" class="map-section" style="display: none;">
            <div class="map-header">
                <h3>
                    <i data-lucide="map-pin" style="width:20px;height:20px;"></i>
                    Event Map
                </h3>
                <div class="map-controls">
                    <button class="location-btn" id="useLocationBtn">
                        <i data-lucide="crosshair"></i>
                        <span id="locationBtnText">Use My Location</span>
                    </button>
                    <div class="radius-controls" id="radiusControls" style="display: none;">
                        <span>Radius:</span>
                        <button class="radius-btn" data-radius="5">5 km</button>
                        <button class="radius-btn active" data-radius="10">10 km</button>
                        <button class="radius-btn" data-radius="25">25 km</button>
                        <button class="radius-btn" data-radius="50">50 km</button>
                    </div>
                </div>
            </div>
            <div style="position: relative;">
                <div id="eventsMap"></div>
                <div class="map-legend">
                    <h4>Legend</h4>
                    <div class="legend-item">
                        <div class="legend-dot user"></div>
                        <span>Your Location</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot nearby"></div>
                        <span>Nearby Event</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot event"></div>
                        <span>Other Event</span>
                    </div>
                </div>
            </div>
            <div class="map-info-bar">
                <span class="events-in-radius" id="eventsInRadiusText">
                    <strong id="radiusEventCount">0</strong> events shown on map
                </span>
                <span class="user-location-info" id="userLocationText">
                    <i data-lucide="info" style="width:14px;height:14px;"></i>
                    Enable location to see nearby events
                </span>
            </div>
        </div>

        <!-- Grid View -->
        <div id="gridView">
            <div class="events-count" id="eventsCount">Found 0 events</div>
            <div id="eventsGrid" class="events-grid">
                <!-- Event cards will be loaded here dynamically -->
            </div>
        </div>
    </main>

    <script src="app.js"></script>
    <script src="components.js"></script>
    <script>
        lucide.createIcons();
        // Initialize user data
        updateUserCoins();
        updateUserAvatar();

        // Events data and state
        let eventsData = [];
        let currentView = 'grid';
        let selectedCause = 'All';
        let map = null;
        let userLocation = null;
        let userMarker = null;
        let radiusCircle = null;
        let eventMarkers = [];
        let selectedRadius = 10; // Default 10km

        // Custom icons for markers
        const userIcon = L.divIcon({
            className: 'user-marker-pulse',
            html: '<div style="width:20px;height:20px;background:#3b82f6;border:3px solid white;border-radius:50%;box-shadow:0 2px 10px rgba(0,0,0,0.3);"></div>',
            iconSize: [20, 20],
            iconAnchor: [10, 10]
        });

        const eventIcon = L.divIcon({
            className: 'event-marker',
            html: '<div style="width:30px;height:30px;background:#10b981;border:3px solid white;border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 10px rgba(0,0,0,0.3);"><span style="color:white;font-size:14px;">üìç</span></div>',
            iconSize: [30, 30],
            iconAnchor: [15, 15]
        });

        const nearbyEventIcon = L.divIcon({
            className: 'nearby-event-marker',
            html: '<div style="width:35px;height:35px;background:#f59e0b;border:3px solid white;border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 10px rgba(0,0,0,0.3);animation:pulse-ring 1.5s ease infinite;"><span style="color:white;font-size:16px;">‚≠ê</span></div>',
            iconSize: [35, 35],
            iconAnchor: [17, 17]
        });

        // Haversine formula to calculate distance between two coordinates
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth's radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Fetch events from backend API
        async function fetchEvents() {
            try {
                const response = await fetch(`${API_BASE_URL}/events`);
                if (response.ok) {
                    const data = await response.json();
                    eventsData = data.filter(event => event.status === 'active').map(event => ({
                        id: event.id,
                        title: event.title,
                        organizer: event.organizerName || 'Unknown Organization',
                        date: event.date,
                        time: event.time || event.endTime || 'TBD',
                        location: `${event.location}${event.city ? ', ' + event.city : ''}`,
                        coordinates: event.latitude && event.longitude ? [event.latitude, event.longitude] : null,
                        cause: capitalizeFirst(event.cause || 'Other'),
                        volunteers: event.volunteersRegistered || 0,
                        spots: event.capacity || 50,
                        coinsReward: event.pointsReward || 100,
                        description: event.description || 'No description available.',
                        image: event.imageUrl || '/placeholder.svg'
                    }));
                    console.log('Loaded events:', eventsData);
                    renderEvents();
                    return eventsData;
                }
            } catch (error) {
                console.error('Error fetching events:', error);
            }
            return [];
        }

        function capitalizeFirst(str) {
            if (!str) return 'Other';
            return str.charAt(0).toUpperCase() + str.slice(1).toLowerCase();
        }

        // Initialize events page
        async function initEventsPage() {
            await fetchEvents();
            setupEventListeners();
        }

        function setupEventListeners() {
            // View toggle
            document.getElementById('gridViewBtn').addEventListener('click', () => switchView('grid'));
            document.getElementById('mapViewBtn').addEventListener('click', () => switchView('map'));

            // Filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    selectedCause = this.dataset.cause;
                    renderEvents();
                    if (currentView === 'map') {
                        updateMapMarkers();
                    }
                });
            });

            // Location button
            document.getElementById('useLocationBtn').addEventListener('click', getUserLocation);

            // Radius buttons
            document.querySelectorAll('.radius-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.radius-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    selectedRadius = parseInt(this.dataset.radius);
                    if (userLocation) {
                        updateRadiusCircle();
                        updateMapMarkers();
                        updateNearbyAlert();
                    }
                });
            });
        }

        function getUserLocation() {
            const btn = document.getElementById('useLocationBtn');
            const btnText = document.getElementById('locationBtnText');
            
            btn.disabled = true;
            btnText.textContent = 'Getting location...';
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        
                        console.log('User location obtained:', userLocation);
                        
                        btnText.textContent = 'Location Enabled ‚úì';
                        btn.style.background = 'rgba(255,255,255,0.4)';
                        
                        // Show radius controls
                        document.getElementById('radiusControls').style.display = 'flex';
                        
                        // Update map
                        if (map) {
                            addUserMarker();
                            updateRadiusCircle();
                            updateMapMarkers();
                            map.setView([userLocation.lat, userLocation.lng], 12);
                        }
                        
                        // Update nearby alert
                        updateNearbyAlert();
                        
                        // Update info text
                        document.getElementById('userLocationText').innerHTML = `
                            <i data-lucide="check-circle" style="width:14px;height:14px;color:#10b981;"></i>
                            Location enabled ‚Ä¢ ${selectedRadius}km radius
                        `;
                        lucide.createIcons();
                        
                        btn.disabled = false;
                    },
                    (error) => {
                        console.error('Geolocation error:', error);
                        let errorMsg = 'Unable to get location.';
                        
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMsg = 'Location permission denied. Please allow location access.';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMsg = 'Location unavailable. Try again.';
                                break;
                            case error.TIMEOUT:
                                errorMsg = 'Location request timed out. Try again.';
                                break;
                        }
                        
                        btnText.textContent = 'Location Failed';
                        btn.disabled = false;
                        
                        setTimeout(() => {
                            btnText.textContent = 'Use My Location';
                        }, 2000);
                        
                        alert(errorMsg);
                    },
                    { 
                        enableHighAccuracy: true, 
                        timeout: 15000,
                        maximumAge: 0 
                    }
                );
            } else {
                alert('Geolocation is not supported by your browser');
                btnText.textContent = 'Not Supported';
                btn.disabled = false;
            }
        }

        function addUserMarker() {
            if (userMarker) {
                map.removeLayer(userMarker);
            }
            userMarker = L.marker([userLocation.lat, userLocation.lng], { icon: userIcon })
                .addTo(map)
                .bindPopup('<strong>üìç Your Location</strong>');
        }

        function updateRadiusCircle() {
            if (radiusCircle) {
                map.removeLayer(radiusCircle);
            }
            radiusCircle = L.circle([userLocation.lat, userLocation.lng], {
                radius: selectedRadius * 1000, // Convert km to meters
                color: '#3b82f6',
                fillColor: '#3b82f6',
                fillOpacity: 0.1,
                weight: 2,
                dashArray: '5, 5'
            }).addTo(map);
            
            // Update info text
            document.getElementById('userLocationText').innerHTML = `
                <i data-lucide="check-circle" style="width:14px;height:14px;color:#10b981;"></i>
                Location enabled ‚Ä¢ ${selectedRadius}km radius
            `;
            lucide.createIcons();
        }

        function updateNearbyAlert() {
            if (!userLocation) return;
            
            const nearbyEvents = eventsData.filter(event => {
                if (!event.coordinates) return false;
                const distance = calculateDistance(
                    userLocation.lat, userLocation.lng,
                    event.coordinates[0], event.coordinates[1]
                );
                return distance <= selectedRadius;
            });
            
            const alertDiv = document.getElementById('nearbyAlert');
            const countSpan = document.getElementById('nearbyCount');
            const textP = document.getElementById('nearbyText');
            
            countSpan.textContent = nearbyEvents.length;
            
            if (nearbyEvents.length > 0) {
                alertDiv.classList.add('show');
                textP.textContent = `${nearbyEvents.length} event${nearbyEvents.length > 1 ? 's' : ''} found within ${selectedRadius}km of your location`;
            } else {
                textP.textContent = `No events found within ${selectedRadius}km. Try increasing the radius.`;
                alertDiv.classList.add('show');
            }
            
            lucide.createIcons();
        }

        function switchView(view) {
            currentView = view;
            const gridViewBtn = document.getElementById('gridViewBtn');
            const mapViewBtn = document.getElementById('mapViewBtn');
            const gridView = document.getElementById('gridView');
            const mapView = document.getElementById('mapView');

            if (view === 'grid') {
                gridViewBtn.classList.replace('btn-outline', 'btn-primary');
                mapViewBtn.classList.replace('btn-primary', 'btn-outline');
                gridView.style.display = 'block';
                mapView.style.display = 'none';
            } else {
                gridViewBtn.classList.replace('btn-primary', 'btn-outline');
                mapViewBtn.classList.replace('btn-outline', 'btn-primary');
                gridView.style.display = 'none';
                mapView.style.display = 'block';
                initMap();
            }
        }

        function renderEvents() {
            const filteredEvents = selectedCause === 'All'
                ? eventsData
                : eventsData.filter(e => e.cause.toLowerCase() === selectedCause.toLowerCase());

            document.getElementById('eventsCount').textContent =
                `Found ${filteredEvents.length} event${filteredEvents.length !== 1 ? 's' : ''}`;

            const grid = document.getElementById('eventsGrid');
            
            if (filteredEvents.length === 0) {
                grid.innerHTML = `
                    <div class="no-events" style="grid-column: 1/-1; text-align: center; padding: 3rem;">
                        <i data-lucide="calendar-x" style="width: 64px; height: 64px; color: var(--text-muted); margin-bottom: 1rem;"></i>
                        <h3 style="color: var(--text-secondary); margin-bottom: 0.5rem;">No Events Found</h3>
                        <p style="color: var(--text-muted);">Check back later for new volunteer opportunities!</p>
                    </div>
                `;
            } else {
                grid.innerHTML = filteredEvents.map(event => createEventCard(event)).join('');
            }

            lucide.createIcons();
        }

        function initMap() {
            const mapContainer = document.getElementById('eventsMap');
            
            // Ensure container has proper dimensions
            if (mapContainer && (!mapContainer.style.height || mapContainer.offsetHeight === 0)) {
                mapContainer.style.height = '400px';
                mapContainer.style.minHeight = '400px';
            }
            
            if (!map) {
                // Default center - will be updated based on events or user location
                const defaultCenter = [20.5937, 78.9629]; // India center
                
                try {
                    map = L.map('eventsMap').setView(defaultCenter, 5);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '¬© OpenStreetMap contributors'
                    }).addTo(map);
                    
                    // Fix map rendering issues
                    setTimeout(function() {
                        if (map) {
                            map.invalidateSize();
                            console.log('Events map size invalidated');
                        }
                    }, 200);
                    
                    // If user location was already set, add marker
                    if (userLocation) {
                        addUserMarker();
                        updateRadiusCircle();
                        map.setView([userLocation.lat, userLocation.lng], 12);
                    }
                } catch (error) {
                    console.error('Error initializing map:', error);
                }
            }
            
            updateMapMarkers();
        }

        function updateMapMarkers() {
            // Clear existing event markers
            eventMarkers.forEach(marker => map.removeLayer(marker));
            eventMarkers = [];
            
            // Filter events by cause
            const filteredEvents = selectedCause === 'All'
                ? eventsData
                : eventsData.filter(e => e.cause.toLowerCase() === selectedCause.toLowerCase());
            
            let nearbyCount = 0;
            
            filteredEvents.forEach(event => {
                if (!event.coordinates) return;
                
                let isNearby = false;
                let distance = null;
                
                if (userLocation) {
                    distance = calculateDistance(
                        userLocation.lat, userLocation.lng,
                        event.coordinates[0], event.coordinates[1]
                    );
                    isNearby = distance <= selectedRadius;
                    if (isNearby) nearbyCount++;
                }
                
                const icon = isNearby ? nearbyEventIcon : eventIcon;
                const distanceText = distance ? `<div class="event-popup-meta">üìè ${distance.toFixed(1)} km away</div>` : '';
                
                const marker = L.marker(event.coordinates, { icon })
                    .addTo(map)
                    .bindPopup(`
                        <div class="event-popup" style="min-width: 220px;">
                            <h4 style="margin-bottom: 0.5rem;">${event.title}</h4>
                            <div class="event-popup-meta">üìÖ ${event.date}</div>
                            <div class="event-popup-meta">üìç ${event.location}</div>
                            <div class="event-popup-meta">üè∑Ô∏è ${event.cause}</div>
                            ${distanceText}
                            <div class="event-popup-reward">ü™ô ${event.coinsReward} coins</div>
                            <div class="event-popup-description" style="font-size: 0.8rem; color: #64748b; margin: 0.5rem 0; line-height: 1.4;">
                                ${event.description || 'Join us for this exciting volunteer opportunity!'}
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="event-popup-btn" style="flex: 1;" onclick="handleEventRegistration(${event.id})">
                                    Register
                                </button>
                            </div>
                        </div>
                    `, { maxWidth: 280 });
                
                eventMarkers.push(marker);
            });
            
            // Update count display
            document.getElementById('radiusEventCount').textContent = filteredEvents.filter(e => e.coordinates).length;
            
            // Fit map to show all markers if no user location
            if (!userLocation && eventMarkers.length > 0) {
                const group = L.featureGroup(eventMarkers);
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }

        // Initialize page
        initEventsPage();
    </script>
</body>

</html>