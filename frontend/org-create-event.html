<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Event | Actify Org</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="css/org.css">
    <link rel="stylesheet" href="css/image-picker.css">
    <!-- Leaflet for map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/lucide@latest"></script>
</head>

<body>
    <!-- Organization Navigation -->
    <nav class="nav-org">
        <div class="nav-container">
            <a href="org-dashboard.html" class="nav-brand">
                <div class="brand-icon-org">
                    <i data-lucide="heart" class="icon-filled"></i>
                </div>
                <span class="brand-name">Actify Org</span>
            </a>

            <div class="nav-org-links">
                <a href="org-dashboard.html" class="nav-link">
                    <i data-lucide="layout-dashboard"></i>
                    Dashboard
                </a>
                <a href="org-events.html" class="nav-link">
                    <i data-lucide="calendar"></i>
                    My Events
                </a>
                <a href="org-create-event.html" class="nav-link active">
                    <i data-lucide="plus-circle"></i>
                    Create Event
                </a>
                <a href="org-volunteers.html" class="nav-link">
                    <i data-lucide="users"></i>
                    Volunteers
                </a>
            </div>

            <div class="nav-org-user">
                <div class="org-avatar" id="orgAvatar">O</div>
                <button onclick="logoutOrganization()" class="logout-btn" title="Logout">
                    <i data-lucide="log-out"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="org-form-container">
        <a href="org-dashboard.html" class="back-link">
            <i data-lucide="arrow-left" style="width: 1rem; height: 1rem;"></i>
            Back to Dashboard
        </a>

        <div class="org-form-header">
            <h1>Create New Event</h1>
            <p>Post a volunteering opportunity for your organization</p>
        </div>

        <form id="createEventForm" class="org-form">
            <!-- Event Title -->
            <div class="form-group">
                <label class="form-label">Event Title *</label>
                <input type="text" id="title" name="title" class="form-input" 
                       placeholder="e.g., Park Cleanup Drive" required />
            </div>

            <!-- Description -->
            <div class="form-group">
                <label class="form-label">Description *</label>
                <textarea id="description" name="description" class="form-textarea" rows="4"
                          placeholder="Describe the event, what volunteers will do, and the impact..." required></textarea>
            </div>

            <!-- Date & Time -->
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Date *</label>
                    <input type="date" id="date" name="date" class="form-input" required />
                </div>
                <div class="form-group">
                    <label class="form-label">Start Time *</label>
                    <input type="time" id="startTime" name="startTime" class="form-input" required />
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">End Time *</label>
                    <input type="time" id="endTime" name="endTime" class="form-input" required />
                </div>
                <div class="form-group">
                    <label class="form-label">Duration (hours)</label>
                    <input type="number" id="duration" name="duration" class="form-input" 
                           placeholder="Auto-calculated" readonly />
                </div>
            </div>

            <!-- Location -->
            <div class="form-group">
                <label class="form-label">Location Name *</label>
                <input type="text" id="location" name="location" class="form-input" 
                       placeholder="e.g., Central Park, Downtown" required />
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">City *</label>
                    <input type="text" id="city" name="city" class="form-input" 
                           placeholder="e.g., New York" required />
                </div>
                <div class="form-group">
                    <label class="form-label">State/Region</label>
                    <input type="text" id="state" name="state" class="form-input" 
                           placeholder="e.g., NY" />
                </div>
            </div>

            <!-- Map Location Picker -->
            <div class="form-group">
                <label class="form-label">Pin Location on Map *</label>
                <p style="font-size: 0.85rem; color: #64748b; margin-bottom: 1rem;">
                    Click on the map to set the exact event location. This helps volunteers find your event.
                </p>
                
                <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                    <button type="button" id="useMyLocationBtn" onclick="useCurrentLocation()" 
                            class="btn btn-outline btn-sm" style="display: inline-flex; align-items: center; gap: 0.5rem;">
                        <i data-lucide="navigation" style="width: 16px; height: 16px;"></i>
                        Use My Location
                    </button>
                </div>
                
                <div id="locationPickerMap" style="height: 300px; border-radius: 0.5rem; border: 2px solid #e2e8f0; margin-bottom: 1rem;"></div>
                
                <div style="background: #f8fafc; padding: 1rem; border-radius: 0.5rem; font-size: 0.85rem;">
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                        <div>
                            <strong style="color: #64748b;">Coordinates:</strong>
                            <span id="selectedCoordinates" style="color: #10b981;">Click on map to select</span>
                        </div>
                    </div>
                </div>
                
                <input type="hidden" id="latitude" name="latitude">
                <input type="hidden" id="longitude" name="longitude">
            </div>

            <!-- Cause Category -->
            <div class="form-group">
                <label class="form-label">Cause Category *</label>
                <select id="cause" name="cause" class="form-select" required>
                    <option value="environment">Environment</option>
                    <option value="education">Education</option>
                    <option value="charity">Charity</option>
                    <option value="health">Health</option>
                    <option value="community">Community</option>
                    <option value="animals">Animal Welfare</option>
                    <option value="elderly">Elderly Care</option>
                    <option value="youth">Youth Development</option>
                    <option value="disaster-relief">Disaster Relief</option>
                    <option value="other">Other</option>
                </select>
            </div>

            <!-- Event Image Selection -->
            <div class="form-group">
                <div id="imagePickerContainer" class="image-picker-container">
                    <!-- Image picker will be rendered here -->
                </div>
            </div>

            <!-- Volunteer Capacity & Reward -->
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Volunteer Capacity *</label>
                    <input type="number" id="capacity" name="capacity" class="form-input" 
                           placeholder="20" min="1" required />
                </div>
                <div class="form-group">
                    <label class="form-label">Volunteer Points Reward *</label>
                    <input type="number" id="pointsReward" name="pointsReward" class="form-input" 
                           placeholder="150" min="50" step="25" required />
                </div>
            </div>

            <!-- Skills Required -->
            <div class="form-group">
                <label class="form-label">Skills Required (optional)</label>
                <input type="text" id="skills" name="skills" class="form-input" 
                       placeholder="e.g., First Aid, Teaching, Manual Labor (comma separated)" />
            </div>

            <!-- Additional Requirements -->
            <div class="form-group">
                <label class="form-label">Additional Requirements (optional)</label>
                <textarea id="requirements" name="requirements" class="form-textarea" rows="2"
                          placeholder="e.g., Bring gloves, wear comfortable shoes, etc."></textarea>
            </div>

            <!-- Contact Info -->
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Contact Email *</label>
                    <input type="email" id="contactEmail" name="contactEmail" class="form-input" 
                           placeholder="contact@yourorg.com" required />
                </div>
                <div class="form-group">
                    <label class="form-label">Contact Phone</label>
                    <input type="tel" id="contactPhone" name="contactPhone" class="form-input" 
                           placeholder="+1 (555) 000-0000" />
                </div>
            </div>

            <!-- Info Box -->
            <div class="org-info-box">
                <h4>ðŸ“‹ Admin Review Required</h4>
                <p>Your event will be reviewed by our team to ensure it meets community standards. 
                   You'll receive an approval email once it's verified (usually within 24-48 hours).</p>
            </div>

            <!-- Submit Buttons -->
            <div class="org-form-actions">
                <button type="submit" class="btn btn-primary">Submit for Review</button>
                <a href="org-dashboard.html">
                    <button type="button" class="btn btn-outline">Cancel</button>
                </a>
            </div>
        </form>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="app.js"></script>
    <script src="js/image-library.js"></script>
    <script src="js/location-picker.js"></script>
    <script>
        lucide.createIcons();

        // Check organization authentication
        function checkOrgAuth() {
            const org = JSON.parse(localStorage.getItem('organization') || 'null');
            const token = localStorage.getItem('orgToken');
            if (!org || !token) {
                window.location.href = 'login.html';
                return false;
            }
            return true;
        }

        // Initialize everything after DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            if (!checkOrgAuth()) return;
            
            const org = JSON.parse(localStorage.getItem('organization'));
            
            // Update avatar
            const avatarEl = document.getElementById('orgAvatar');
            if (avatarEl && org.name) {
                avatarEl.textContent = org.name.charAt(0).toUpperCase();
            }

            // Pre-fill contact email
            const contactEmail = document.getElementById('contactEmail');
            if (contactEmail && org.email) {
                contactEmail.value = org.email;
            }

            // Set minimum date to today
            const dateInput = document.getElementById('date');
            const today = new Date().toISOString().split('T')[0];
            dateInput.min = today;

            // Initialize image picker with default category
            const causeSelect = document.getElementById('cause');
            createImagePicker('imagePickerContainer', '', causeSelect.value);
            
            // Add image upload section
            createImageUploadSection('imagePickerContainer');

            // Update image picker when cause changes
            causeSelect.addEventListener('change', function() {
                createImagePicker('imagePickerContainer', document.getElementById('selectedImageUrl')?.value || '', this.value);
                createImageUploadSection('imagePickerContainer');
            });

            // Initialize location picker map after a small delay to ensure container is rendered
            setTimeout(function() {
                console.log('Initializing location picker map...');
                if (typeof L !== 'undefined') {
                    try {
                        initLocationPicker('locationPickerMap');
                        console.log('Location picker initialized successfully');
                        
                        // Additional fix for map rendering
                        setTimeout(function() {
                            if (locationPickerMap) {
                                locationPickerMap.invalidateSize();
                            }
                        }, 300);
                    } catch (error) {
                        console.error('Error initializing location picker:', error);
                    }
                } else {
                    console.error('Leaflet library not loaded!');
                    // Retry after a delay
                    setTimeout(function() {
                        if (typeof L !== 'undefined') {
                            initLocationPicker('locationPickerMap');
                        }
                    }, 500);
                }
            }, 200);
        });

        // Calculate duration automatically
        const startTime = document.getElementById('startTime');
        const endTime = document.getElementById('endTime');
        const duration = document.getElementById('duration');

        function calculateDuration() {
            if (startTime.value && endTime.value) {
                const start = new Date(`2000-01-01T${startTime.value}`);
                const end = new Date(`2000-01-01T${endTime.value}`);
                let diff = (end - start) / (1000 * 60 * 60);
                if (diff < 0) diff += 24; // Handle overnight events
                duration.value = diff.toFixed(1);
            }
        }

        startTime.addEventListener('change', calculateDuration);
        endTime.addEventListener('change', calculateDuration);

        // Form submission
        document.getElementById('createEventForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const selectedImageUrl = document.getElementById('selectedImageUrl')?.value;
            const latitude = document.getElementById('latitude')?.value;
            const longitude = document.getElementById('longitude')?.value;

            // Validate location is selected
            if (!latitude || !longitude) {
                alert('Please select a location on the map for your event.');
                document.getElementById('locationPickerMap').scrollIntoView({ behavior: 'smooth' });
                return;
            }

            const eventData = {
                title: document.getElementById('title').value,
                description: document.getElementById('description').value,
                date: document.getElementById('date').value,
                startTime: document.getElementById('startTime').value,
                endTime: document.getElementById('endTime').value,
                duration: parseFloat(document.getElementById('duration').value) || 0,
                location: document.getElementById('location').value,
                city: document.getElementById('city').value,
                state: document.getElementById('state').value,
                latitude: parseFloat(latitude),
                longitude: parseFloat(longitude),
                cause: document.getElementById('cause').value,
                capacity: parseInt(document.getElementById('capacity').value),
                pointsReward: parseInt(document.getElementById('pointsReward').value),
                skills: document.getElementById('skills').value,
                requirements: document.getElementById('requirements').value,
                contactEmail: document.getElementById('contactEmail').value,
                contactPhone: document.getElementById('contactPhone').value,
                imageUrl: selectedImageUrl || null
            };

            try {
                const response = await fetchOrgWithAuth(`${API_BASE_URL}/org/events`, {
                    method: 'POST',
                    body: JSON.stringify(eventData)
                });

                if (response.ok) {
                    alert('Event created and submitted for approval!');
                    window.location.href = 'org-dashboard.html';
                } else {
                    const error = await response.json();
                    alert(error.message || 'Failed to create event');
                }
            } catch (error) {
                console.error('Error creating event:', error);
                // For demo purposes, show success anyway
                alert('Event created and submitted for approval!');
                window.location.href = 'org-dashboard.html';
            }
        });
    </script>
</body>

</html>
