<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Badges | Actify</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="css/badges.css">
    <script src="https://unpkg.com/lucide@latest"></script>
</head>

<body>
    <!-- Navigation -->
    <nav class="nav-logged-in">
        <div class="nav-container">
            <a href="dashboard.html" class="nav-brand">
                <div class="brand-icon-small">
                    <i data-lucide="heart" class="icon-filled"></i>
                </div>
                <span class="brand-name">Actify</span>
            </a>

            <div class="nav-links-main">
                <a href="dashboard.html" class="nav-link">
                    <i data-lucide="heart"></i>
                    Dashboard
                </a>
                <a href="events.html" class="nav-link">
                    <i data-lucide="map-pin"></i>
                    Events
                </a>
                <a href="rewards.html" class="nav-link">
                    <i data-lucide="gift"></i>
                    Rewards
                </a>
                <a href="leaderboard.html" class="nav-link">
                    <i data-lucide="trophy"></i>
                    Leaderboard
                </a>
            </div>

            <div class="nav-user">
                <div class="user-coins">
                    <span class="coin-value">0</span>
                </div>
                <span class="coin-icon">ðŸª™</span>
                <a href="profile.html" style="text-decoration: none;">
                    <div class="user-avatar" style="cursor: pointer;">A</div>
                </a>
                <button onclick="logout()" class="logout-btn" title="Logout">
                    <i data-lucide="log-out"></i>
                </button>
            </div>
        </div>

        <!-- Mobile Navigation -->
        <div class="nav-mobile">
            <a href="dashboard.html" class="nav-mobile-item">
                <i data-lucide="heart"></i>
                <span>Dashboard</span>
            </a>
            <a href="events.html" class="nav-mobile-item">
                <i data-lucide="map-pin"></i>
                <span>Events</span>
            </a>
            <a href="rewards.html" class="nav-mobile-item">
                <i data-lucide="gift"></i>
                <span>Rewards</span>
            </a>
            <a href="leaderboard.html" class="nav-mobile-item">
                <i data-lucide="trophy"></i>
                <span>Leaderboard</span>
            </a>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-container">
        <!-- Page Header -->
        <div class="page-header">
            <h1 class="page-title">
                <i data-lucide="trophy"
                    style="display: inline-block; vertical-align: middle; color: var(--primary);"></i>
                Badge System
            </h1>
            <p class="page-subtitle">Earn badges by reaching milestones and completing verified events</p>
            <p class="badge-counter" id="badgeCounter">Loading badges...</p>
        </div>

        <!-- Welcome Badges -->
        <div class="badge-category">
            <h2 class="category-title">Getting Started</h2>
            <p class="category-description">Welcome badges for joining and taking your first steps</p>
            <div class="badges-showcase" id="welcomeBadges">
                <!-- Dynamically loaded -->
            </div>
        </div>

        <!-- Event Milestones -->
        <div class="badge-category">
            <h2 class="category-title">Event Milestones</h2>
            <p class="category-description">Complete verified volunteer events to unlock these badges</p>
            <div class="badges-showcase" id="eventBadges">
                <!-- Dynamically loaded -->
            </div>
        </div>

        <!-- Cause Specialists -->
        <div class="badge-category">
            <h2 class="category-title">Cause Specialists</h2>
            <p class="category-description">Focus on specific causes to earn badges</p>
            <div class="badges-showcase" id="causeBadges">
                <!-- Dynamically loaded -->
            </div>
        </div>

        <!-- Impact Tiers -->
        <div class="badge-category">
            <h2 class="category-title">Impact Tiers</h2>
            <p class="category-description">Earn points from verified events to unlock these</p>
            <div class="badges-showcase" id="impactBadges">
                <!-- Dynamically loaded -->
            </div>
        </div>

        <!-- Info Section -->
        <div class="info-section">
            <h2 class="section-title-sm">How Badge System Works</h2>
            <div class="info-grid">
                <div class="info-item">
                    <h3>What are badges?</h3>
                    <p>Badges are digital achievements that recognize your volunteering dedication and impact across
                        different areas and milestones.</p>
                </div>
                <div class="info-item">
                    <h3>How do I earn them?</h3>
                    <p>Complete events, reach milestones with Impact Coins, volunteer consistently, and focus on
                        specific causes to unlock new badges.</p>
                </div>
                <div class="info-item">
                    <h3>Display your badges</h3>
                    <p>Your earned badges appear on your public profile and leaderboard, showcasing your commitment to
                        the community.</p>
                </div>
                <div class="info-item">
                    <h3>What's next?</h3>
                    <p>More badges are added regularly. Check back often to see new challenges and ways to earn
                        recognition.</p>
                </div>
            </div>
        </div>
    </main>

    <script src="app.js"></script>
    <script>
        // SECURITY: Check authentication before allowing access
        (function() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'login.html';
                return;
            }
        })();
        
        lucide.createIcons();
        updateUserCoins();
        updateUserAvatar();

        // Badge definitions
        const allBadges = {
            welcome: [
                { id: 'new-volunteer', name: 'New Volunteer', icon: 'ðŸŽ‰', description: 'Join Actify', requirement: 'joined' },
                { id: 'first-registration', name: 'First Registration', icon: 'ðŸ“', description: 'Register for your first event', requirement: 'registered' }
            ],
            events: [
                { id: 'first-step', name: 'First Steps', icon: 'ðŸŒ±', description: 'Complete 1 verified event', requirement: 1, type: 'events' },
                { id: 'helper', name: 'Community Helper', icon: 'ðŸ¤', description: 'Complete 5 verified events', requirement: 5, type: 'events' },
                { id: 'hero', name: 'Community Hero', icon: 'ðŸ¦¸', description: 'Complete 10 verified events', requirement: 10, type: 'events' },
                { id: 'champion', name: 'Champion', icon: 'ðŸ†', description: 'Complete 25 verified events', requirement: 25, type: 'events' },
                { id: 'legend', name: 'Legend', icon: 'ðŸ‘‘', description: 'Complete 50 verified events', requirement: 50, type: 'events' }
            ],
            cause: [
                { id: 'green-guardian', name: 'Green Guardian', icon: 'ðŸŒ¿', description: '5 Environment events', requirement: 5, type: 'environment' },
                { id: 'edu-champion', name: 'Education Champion', icon: 'ðŸ“š', description: '5 Education events', requirement: 5, type: 'education' },
                { id: 'health-hero', name: 'Health Hero', icon: 'âš•ï¸', description: '5 Health events', requirement: 5, type: 'health' },
                { id: 'community-builder', name: 'Community Builder', icon: 'ðŸ˜ï¸', description: '5 Community events', requirement: 5, type: 'community' }
            ],
            impact: [
                { id: 'bronze', name: 'Bronze Contributor', icon: 'ðŸ¥‰', description: '500 coins earned', requirement: 500, type: 'points' },
                { id: 'silver', name: 'Silver Contributor', icon: 'ðŸ¥ˆ', description: '1,500 coins earned', requirement: 1500, type: 'points' },
                { id: 'gold', name: 'Gold Contributor', icon: 'ðŸ¥‡', description: '3,000 coins earned', requirement: 3000, type: 'points' },
                { id: 'platinum', name: 'Platinum Impact', icon: 'ðŸ’Ž', description: '5,000 coins earned', requirement: 5000, type: 'points' }
            ]
        };

        // Load badges on page load
        async function loadBadges() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE_URL}/users/profile`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                let userData = { volunteerPoints: 0, eventsCompleted: 0 };
                if (response.ok) {
                    userData = await response.json();
                } else {
                    const stored = localStorage.getItem('user');
                    if (stored) userData = JSON.parse(stored);
                }

                // Check for registration status
                const registrations = JSON.parse(localStorage.getItem('userRegistrations') || '[]');
                const hasRegistered = registrations.length > 0;

                renderBadgeCategory('welcomeBadges', allBadges.welcome, userData, hasRegistered);
                renderBadgeCategory('eventBadges', allBadges.events, userData, hasRegistered);
                renderBadgeCategory('causeBadges', allBadges.cause, userData, hasRegistered);
                renderBadgeCategory('impactBadges', allBadges.impact, userData, hasRegistered);

                // Update counter
                const totalEarned = countEarnedBadges(userData, hasRegistered);
                const totalBadges = Object.values(allBadges).flat().length;
                document.getElementById('badgeCounter').textContent = `${totalEarned} of ${totalBadges} badges earned`;

                lucide.createIcons();
            } catch (error) {
                console.error('Error loading badges:', error);
            }
        }

        function countEarnedBadges(userData, hasRegistered) {
            let count = 2; // Welcome badges (joined + registered if applicable)
            if (!hasRegistered) count = 1;
            
            const points = userData.volunteerPoints || 0;
            const events = userData.eventsCompleted || 0;

            // Event badges
            allBadges.events.forEach(b => { if (events >= b.requirement) count++; });
            // Impact badges
            allBadges.impact.forEach(b => { if (points >= b.requirement) count++; });
            
            return count;
        }

        function renderBadgeCategory(containerId, badges, userData, hasRegistered) {
            const container = document.getElementById(containerId);
            if (!container) return;

            const points = userData.volunteerPoints || 0;
            const events = userData.eventsCompleted || 0;

            container.innerHTML = badges.map(badge => {
                let earned = false;
                
                // Check if badge is earned
                if (badge.requirement === 'joined') {
                    earned = true; // Always earned once they're on this page
                } else if (badge.requirement === 'registered') {
                    earned = hasRegistered;
                } else if (badge.type === 'events') {
                    earned = events >= badge.requirement;
                } else if (badge.type === 'points') {
                    earned = points >= badge.requirement;
                }
                // Cause badges stay locked by default (would need event-type tracking)

                return `
                    <div class="badge-card ${earned ? 'earned' : 'locked'}">
                        <div class="badge-icon-large ${earned ? '' : 'locked-icon'}">${badge.icon}</div>
                        ${!earned ? '<div class="lock-overlay"><i data-lucide="lock"></i></div>' : ''}
                        <h3 class="badge-title">${badge.name}</h3>
                        <p class="badge-description">${badge.description}</p>
                        <div class="badge-status ${earned ? 'earned' : 'locked'}">
                            <i data-lucide="${earned ? 'check-circle-2' : 'lock'}"></i>
                            <span>${earned ? 'Earned' : 'Locked'}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Initialize
        loadBadges();
    </script>
</body>

</html>