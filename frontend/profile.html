<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile | Actify</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="css/profile.css">
    <link rel="stylesheet" href="css/image-picker.css">
</head>

<body class="profile-page">
    <nav class="nav-logged-in">
        <div class="nav-container">
            <a href="index.html" class="nav-brand">
                <div class="brand-icon-small">
                    <i data-lucide="heart" class="icon-filled"></i>
                </div>
                <span class="brand-name">Actify</span>
            </a>

            <div class="nav-links-main">
                <a href="dashboard.html" class="nav-link">
                    <i data-lucide="heart" class="animate-heart-beat"></i>
                    Dashboard
                </a>
                <a href="events.html" class="nav-link">
                    <i data-lucide="map-pin"></i>
                    Events
                </a>
                <a href="rewards.html" class="nav-link">
                    <i data-lucide="gift"></i>
                    Rewards
                </a>
                <a href="leaderboard.html" class="nav-link">
                    <i data-lucide="trophy"></i>
                    Leaderboard
                </a>
                <a href="badges.html" class="nav-link">
                    <i data-lucide="award"></i>
                    Badges
                </a>
            </div>

            <div class="nav-user">
                <div class="user-coins">
                    <span class="coin-value" id="coinValue">0</span>
                </div>
                <span class="coin-icon">ðŸª™</span>
                <a href="profile.html" style="text-decoration: none;">
                    <div class="user-avatar" id="navAvatar" style="cursor: pointer;">U</div>
                </a>
                <button onclick="logout()" class="logout-btn" title="Logout">
                    <i data-lucide="log-out"></i>
                </button>
            </div>
        </div>

        <!-- Mobile Navigation -->
        <div class="nav-mobile">
            <a href="dashboard.html" class="nav-mobile-item">
                <i data-lucide="heart" class="animate-heart-beat"></i>
                <span>Dashboard</span>
            </a>
            <a href="events.html" class="nav-mobile-item">
                <i data-lucide="map-pin"></i>
                <span>Events</span>
            </a>
            <a href="rewards.html" class="nav-mobile-item">
                <i data-lucide="gift"></i>
                <span>Rewards</span>
            </a>
            <a href="leaderboard.html" class="nav-mobile-item">
                <i data-lucide="trophy"></i>
                <span>Leaderboard</span>
            </a>
        </div>
    </nav>

    <main class="profile-container">
        <section class="profile-card gradient-border profile-hero">
            <div class="profile-header-new">
                <div class="avatar-upload-container">
                    <div class="profile-avatar-new" id="profileAvatarNew">
                        <img id="profileAvatarImg" src="" alt="Profile" style="display:none; width:100%; height:100%; object-fit:cover; border-radius:50%;">
                        <span id="profileAvatarLetter">U</span>
                    </div>
                    <!-- Main upload button for image -->
                    <label for="profileImageUpload" class="avatar-upload-btn" title="Upload Photo">
                        <i data-lucide="camera"></i>
                    </label>
                    <input type="file" id="profileImageUpload" accept="image/*" style="display:none;">
                </div>
                <p class="profile-welcome" id="profileWelcome">Welcome back, Volunteer!</p>
                <!-- <h1 class="profile-name-new" id="profileNameNew">Loading...</h1> -->
                <p class="profile-email-new" id="profileEmailNew">Loading...</p>
                <p class="profile-join-date" id="profileJoinDate"></p>
                <div class="profile-actions">
                    <button class="profile-action-btn" id="shareProfileBtn">
                        <i data-lucide="share-2"></i>
                        Share profile
                </button>
        </div>
        <div class="profile-stats-new">
            <div class="stat-item-new">
                <span class="stat-number-new" id="pointsDisplay">0</span>
                <span class="stat-label-new">Impact Coins</span>
            </div>
            <div class="stat-item-new">
                <span class="stat-number-new" id="eventsDisplay">0</span>
                <span class="stat-label-new">Events Completed</span>
            </div>
            <div class="stat-item-new">
                <span class="stat-number-new" id="hoursDisplay">0</span>
                <span class="stat-label-new">Hours Volunteered</span>
            </div>
            <div class="stat-item-new">
                <span class="stat-number-new" id="badgesDisplay">0</span>
                <span class="stat-label-new">Badges Earned</span>
            </div>
        </div>
        </div>

        <div class="profile-content-new">
            <div class="stats-grid">
                <div class="stat-card-new">
                    <div class="stat-card-icon gradient-border-subtle">
                        <i data-lucide="coins"></i>
                    </div>
                    <p class="stat-card-label">Total Coins</p>
                    <p class="stat-card-value" data-field="coins">0</p>
                    <span class="stat-card-subtext">Lifetime Impact Coins</span>
                </div>
                <div class="stat-card-new">
                    <div class="stat-card-icon gradient-border-subtle">
                        <i data-lucide="target"></i>
                    </div>
                    <p class="stat-card-label">Events Completed</p>
                    <p class="stat-card-value" data-field="events">0</p>
                    <span class="stat-card-subtext">Across all causes</span>
                </div>
                <div class="stat-card-new">
                    <div class="stat-card-icon gradient-border-subtle">
                        <i data-lucide="clock-8"></i>
                    </div>
                    <p class="stat-card-label">Hours Contributed</p>
                    <p class="stat-card-value" data-field="hours">0</p>
                    <span class="stat-card-subtext">Documented volunteer time</span>
                </div>
            </div>

            <section class="profile-section-modern gradient-border">
                <div class="section-heading">
                    <div>
                        <h2>Badges Earned</h2>
                        <p>Milestones from your volunteer journey</p>
                    </div>
                    <span class="section-pill" id="badgeCountLabel">0 / 0 badges</span>
                </div>
                <div class="badge-grid" id="badgeGrid">
                    <p class="empty-state">Loading your badges...</p>
                </div>
            </section>

            <section class="progress-section gradient-border">
                <div class="section-heading">
                    <div>
                        <h2>Achievement Progress</h2>
                        <p>Track your progress toward the next tier</p>
                    </div>
                </div>
                <div class="achievement-list" id="achievementList">
                    <p class="empty-state">Loading achievements...</p>
                </div>
            </section>

            <section class="profile-section-modern gradient-border">
                <div class="section-heading">
                    <div>
                        <h2>Causes You Support</h2>
                        <p>Based on your selected interests and history</p>
                    </div>
                </div>
                <div class="causes-row" id="causesChips">
                    <p class="empty-state">Loading causes...</p>
                </div>
            </section>
        </div>
        </section>
        </main>

        <script src="https://unpkg.com/lucide@latest"></script>
        <script src="app.js"></script>
        <script src="js/image-library.js"></script>
        <script>
            // SECURITY: Check authentication before allowing access
            (function() {
                const token = localStorage.getItem('token');
                if (!token) {
                    window.location.href = 'login.html';
                    return;
                }
            })();
            
            // Define badges data - same as badges.html for consistency
            const allBadges = [
                { id: 'new-volunteer', name: 'New Volunteer', icon: 'ðŸŽ‰', description: 'Join Actify', requirement: 'joined' },
                { id: 'first-registration', name: 'First Registration', icon: 'ðŸ“', description: 'Register for your first event', requirement: 'registered' },
                { id: 'first-step', name: 'First Steps', icon: 'ðŸŒ±', description: 'Complete 1 verified event', requirement: 1, type: 'events' },
                { id: 'helping-hand', name: 'Community Helper', icon: 'ðŸ¤', description: 'Complete 5 verified events', requirement: 5, type: 'events' },
                { id: 'community-hero', name: 'Community Hero', icon: 'ðŸ¦¸', description: 'Complete 10 verified events', requirement: 10, type: 'events' },
                { id: 'bronze', name: 'Bronze Contributor', icon: 'ðŸ¥‰', description: 'Earn 500+ points', requirement: 500, type: 'points' },
                { id: 'silver', name: 'Silver Contributor', icon: 'ðŸ¥ˆ', description: 'Earn 1500+ points', requirement: 1500, type: 'points' },
                { id: 'gold', name: 'Gold Contributor', icon: 'ðŸ¥‡', description: 'Earn 3000+ points', requirement: 3000, type: 'points' }
            ];

            // Define achievements data
            const achievements = [
                { id: 'events-bronze', name: 'Events Bronze', description: 'Complete 5 events', progress: 0, target: 5, tier: 'bronze' },
                { id: 'events-silver', name: 'Events Silver', description: 'Complete 15 events', progress: 0, target: 15, tier: 'silver' },
                { id: 'events-gold', name: 'Events Gold', description: 'Complete 30 events', progress: 0, target: 30, tier: 'gold' },
                { id: 'hours-bronze', name: 'Hours Bronze', description: 'Volunteer for 25 hours', progress: 0, target: 25, tier: 'bronze' },
                { id: 'hours-silver', name: 'Hours Silver', description: 'Volunteer for 75 hours', progress: 0, target: 75, tier: 'silver' },
                { id: 'hours-gold', name: 'Hours Gold', description: 'Volunteer for 150 hours', progress: 0, target: 150, tier: 'gold' },
                { id: 'points-bronze', name: 'Points Bronze', description: 'Earn 1000 points', progress: 0, target: 1000, tier: 'bronze' },
                { id: 'points-silver', name: 'Points Silver', description: 'Earn 5000 points', progress: 0, target: 5000, tier: 'silver' },
                { id: 'points-gold', name: 'Points Gold', description: 'Earn 15000 points', progress: 0, target: 15000, tier: 'gold' }
            ];

            // Default causes
            const defaultCauses = ['Environment', 'Education', 'Community', 'Health', 'Animals'];

            document.addEventListener('DOMContentLoaded', () => {
                setupProfileShare();
                setupProfileImageUpload();
                // Load profile data and avatar together to ensure consistency
                loadProfilePageData();
                loadRegisteredEventsFromAPI();
                if (window.lucide) {
                    window.lucide.createIcons();
                }
            });
            
            // Setup profile image upload (main camera button)
            function setupProfileImageUpload() {
                const fileInput = document.getElementById('profileImageUpload');
                
                fileInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    // Validate file
                    if (!file.type.startsWith('image/')) {
                        alert('Please select an image file');
                        return;
                    }
                    
                    if (file.size > 5 * 1024 * 1024) {
                        alert('Image must be less than 5MB');
                        return;
                    }
                    
                    // Read and resize image
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const img = new Image();
                        img.onload = async function() {
                            // Resize logic
                            const canvas = document.createElement('canvas');
                            const MAX_WIDTH = 300;
                            const MAX_HEIGHT = 300;
                            let width = img.width;
                            let height = img.height;

                            if (width > height) {
                                if (width > MAX_WIDTH) {
                                    height *= MAX_WIDTH / width;
                                    width = MAX_WIDTH;
                                }
                            } else {
                                if (height > MAX_HEIGHT) {
                                    width *= MAX_HEIGHT / height;
                                    height = MAX_HEIGHT;
                                }
                            }

                            canvas.width = width;
                            canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            
                            // Get compressed base64 string
                            const imageData = canvas.toDataURL('image/jpeg', 0.7);
                            
                            // Save to localStorage with user-specific key
                            const user = JSON.parse(localStorage.getItem('user') || '{}');
                            const userKey = user.email || user.id || 'guest';
                            try {
                                localStorage.setItem(`profileImage_${userKey}`, imageData);
                            } catch (e) {
                                console.warn('Failed to save image to localStorage', e);
                            }
                            
                            // Display image
                            displayProfileImage(imageData);
                            
                            // Save to backend
                            try {
                                const token = localStorage.getItem('token');
                                if (token) {
                                    const response = await fetch(`${API_BASE_URL}/users/profile/image`, {
                                        method: 'PUT',
                                        headers: {
                                            'Authorization': `Bearer ${token}`,
                                            'Content-Type': 'application/json'
                                        },
                                        body: JSON.stringify({ profileImage: imageData })
                                    });
                                    if (response.ok) {
                                        console.log('Profile image saved to backend');
                                    } else {
                                        console.warn('Failed to save profile image to backend');
                                    }
                                }
                            } catch (error) {
                                console.error('Error saving profile image to backend:', error);
                            }
                        };
                        img.src = event.target.result;
                    };
                    reader.readAsDataURL(file);
                });
            }
            
            // Display profile image
            function displayProfileImage(imageData) {
                const avatarImg = document.getElementById('profileAvatarImg');
                const avatarLetter = document.getElementById('profileAvatarLetter');
                const navAvatar = document.getElementById('navAvatar');
                
                if (avatarImg && imageData) {
                    avatarImg.src = imageData;
                    avatarImg.style.display = 'block';
                    if (avatarLetter) avatarLetter.style.display = 'none';
                    
                    // Also update nav avatar
                    if (navAvatar) {
                        navAvatar.innerHTML = `<img src="${imageData}" alt="Profile" style="width:100%; height:100%; object-fit:cover; border-radius:50%;">`;
                    }
                }
            }
            
            // Load saved avatar on page load
            function loadSavedAvatar() {
                // Get user-specific key
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                const userKey = user.email || user.id || 'guest';
                
                // Check for uploaded image with user-specific key
                const savedImage = localStorage.getItem(`profileImage_${userKey}`);
                if (savedImage) {
                    displayProfileImage(savedImage);
                    return;
                }
                
                // If no image, show first letter of name
                const firstLetter = (user.firstName || 'U').charAt(0).toUpperCase();
                const avatarLetter = document.getElementById('profileAvatarLetter');
                const navAvatar = document.getElementById('navAvatar');
                
                if (avatarLetter) {
                    avatarLetter.textContent = firstLetter;
                    avatarLetter.style.display = 'flex';
                }
                if (navAvatar) {
                    navAvatar.textContent = firstLetter;
                }
            }

            // Load registered events from API and sync to localStorage
            async function loadRegisteredEventsFromAPI() {
                const token = localStorage.getItem('token');
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                const userKey = user.email || user.id || 'guest';
                
                try {
                    if (token) {
                        const response = await fetch(`${API_BASE_URL}/events/user/registered`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        
                        if (response.ok) {
                            const apiRegistrations = await response.json();
                            // Convert API data to array of event IDs for badge counting
                            const registrationIds = apiRegistrations.map(event => event.id);
                            // Save to localStorage with user-specific key
                            localStorage.setItem(`userRegistrations_${userKey}`, JSON.stringify(registrationIds));
                            console.log('Synced registered events from API:', registrationIds.length);
                        }
                    }
                } catch (error) {
                    console.error('Error fetching registered events from API:', error);
                }
            }

            async function loadProfilePageData() {
                try {
                    const token = localStorage.getItem('token');
                    if (!token) {
                        window.location.href = 'login.html';
                        return;
                    }

                    const user = JSON.parse(localStorage.getItem('user') || '{}');
                    const userKey = user.email || user.id || 'guest';

                    // Fetch user profile from API
                    const response = await fetch(`${API_BASE_URL}/users/profile`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    let userData;
                    if (response.ok) {
                        userData = await response.json();
                        
                        // Handle profile image from API
                        if (userData.profileImage) {
                            console.log('Profile image found in API response');
                            // Save to localStorage for quick access on other pages
                            localStorage.setItem(`profileImage_${userKey}`, userData.profileImage);
                            displayProfileImage(userData.profileImage);
                        } else {
                            // No profile image in API, check localStorage as fallback
                            const savedImage = localStorage.getItem(`profileImage_${userKey}`);
                            if (savedImage) {
                                console.log('Profile image found in localStorage');
                                displayProfileImage(savedImage);
                            } else {
                                // No image anywhere - show letter avatar
                                loadSavedAvatar();
                            }
                        }
                    } else {
                        // API failed - use localStorage as fallback
                        const storedUser = localStorage.getItem('user');
                        userData = storedUser ? JSON.parse(storedUser) : {
                            firstName: 'User',
                            lastName: '',
                            email: 'user@example.com',
                            volunteerPoints: 0,
                            eventsCompleted: 0,
                            volunteerHours: 0,
                            interests: ''
                        };
                        // Try to load avatar from localStorage
                        loadSavedAvatar();
                    }

                    // Update profile display
                    updateProfileDisplay(userData);
                    
                    // Render badges based on user stats
                    renderBadges(userData);
                    
                    // Render achievements based on user stats
                    renderAchievements(userData);
                    
                    // Render causes
                    renderCauses(userData.interests);

                } catch (error) {
                    console.error('Error loading profile:', error);
                    // Use default data
                    const defaultData = {
                        firstName: 'User',
                        lastName: '',
                        email: 'user@example.com',
                        volunteerPoints: 0,
                        eventsCompleted: 0,
                        volunteerHours: 0,
                        interests: ''
                    };
                    updateProfileDisplay(defaultData);
                    renderBadges(defaultData);
                    renderAchievements(defaultData);
                    renderCauses('');
                    loadSavedAvatar();
                }
            }

            function updateProfileDisplay(data) {
                // Update welcome message
                const welcomeEl = document.getElementById('profileWelcome');
                if (welcomeEl) {
                    welcomeEl.textContent = `Welcome back, ${data.firstName || 'Volunteer'}!`;
                }

                // Update email
                const emailEl = document.getElementById('profileEmailNew');
                if (emailEl) {
                    emailEl.textContent = data.email || '';
                }

                // Avatar is now handled in loadProfilePageData, so we skip it here
                // to avoid race conditions

                // Update stats
                const points = data.volunteerPoints || 0;
                const events = data.eventsCompleted || 0;
                const hours = data.volunteerHours || 0;

                // Count earned badges
                const earnedBadges = countEarnedBadges(data);

                document.getElementById('pointsDisplay').textContent = points.toLocaleString();
                document.getElementById('eventsDisplay').textContent = events;
                document.getElementById('hoursDisplay').textContent = hours;
                document.getElementById('badgesDisplay').textContent = earnedBadges;
                document.getElementById('coinValue').textContent = points.toLocaleString();

                // Update stat cards
                document.querySelectorAll('[data-field="coins"]').forEach(el => el.textContent = points.toLocaleString());
                document.querySelectorAll('[data-field="events"]').forEach(el => el.textContent = events);
                document.querySelectorAll('[data-field="hours"]').forEach(el => el.textContent = hours);
            }

            function countEarnedBadges(data) {
                let count = 1; // Always have "New Volunteer" badge
                const points = data.volunteerPoints || 0;
                const events = data.eventsCompleted || 0;
                
                // Check if registered for any event (user-specific)
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                const userKey = user.email || user.id || 'guest';
                const registrations = JSON.parse(localStorage.getItem(`userRegistrations_${userKey}`) || '[]');
                if (registrations.length > 0) count++;

                // Event badges
                if (events >= 1) count++;
                if (events >= 5) count++;
                if (events >= 10) count++;
                
                // Points badges
                if (points >= 500) count++;
                if (points >= 1500) count++;
                if (points >= 3000) count++;

                return count;
            }

            function renderBadges(data) {
                const badgeGrid = document.getElementById('badgeGrid');
                const badgeCountLabel = document.getElementById('badgeCountLabel');
                
                if (!badgeGrid) return;

                const points = data.volunteerPoints || 0;
                const events = data.eventsCompleted || 0;
                
                // Get user-specific registrations
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                const userKey = user.email || user.id || 'guest';
                const registrations = JSON.parse(localStorage.getItem(`userRegistrations_${userKey}`) || '[]');
                const hasRegistered = registrations.length > 0;

                // Determine earned badges based on stats
                const badges = allBadges.map(badge => {
                    let earned = false;
                    
                    if (badge.requirement === 'joined') {
                        earned = true; // Always earned
                    } else if (badge.requirement === 'registered') {
                        earned = hasRegistered;
                    } else if (badge.type === 'events') {
                        earned = events >= badge.requirement;
                    } else if (badge.type === 'points') {
                        earned = points >= badge.requirement;
                    }
                    
                    return { ...badge, earned };
                });

                const earnedCount = badges.filter(b => b.earned).length;
                if (badgeCountLabel) {
                    badgeCountLabel.textContent = `${earnedCount} / ${badges.length} badges`;
                }

                badgeGrid.innerHTML = badges.map(badge => `
                    <div class="badge-item ${badge.earned ? 'earned' : 'locked'}">
                        <div class="badge-icon-wrapper ${badge.earned ? '' : 'locked'}">
                            <span class="badge-emoji ${badge.earned ? '' : 'greyed'}">${badge.icon}</span>
                            ${!badge.earned ? '<span class="lock-icon">ðŸ”’</span>' : ''}
                        </div>
                        <span class="badge-name">${badge.name}</span>
                        <span class="badge-desc">${badge.description}</span>
                    </div>
                `).join('');
            }

            function renderAchievements(data) {
                const achievementList = document.getElementById('achievementList');
                if (!achievementList) return;

                const points = data.volunteerPoints || 0;
                const events = data.eventsCompleted || 0;
                const hours = data.volunteerHours || 0;

                // Update achievements with current progress
                const updatedAchievements = achievements.map(ach => {
                    let progress = 0;
                    if (ach.id.startsWith('events')) progress = events;
                    else if (ach.id.startsWith('hours')) progress = hours;
                    else if (ach.id.startsWith('points')) progress = points;
                    
                    return { ...ach, progress: Math.min(progress, ach.target) };
                });

                achievementList.innerHTML = updatedAchievements.map(ach => {
                    const percent = Math.round((ach.progress / ach.target) * 100);
                    const isCompleted = ach.progress >= ach.target;
                    const tierColors = {
                        bronze: '#cd7f32',
                        silver: '#c0c0c0',
                        gold: '#ffd700'
                    };
                    
                    return `
                        <div class="achievement-item ${isCompleted ? 'completed' : ''}">
                            <div class="achievement-info">
                                <div class="achievement-header">
                                    <span class="achievement-name">${ach.name}</span>
                                    <span class="achievement-tier" style="color: ${tierColors[ach.tier]}">
                                        ${isCompleted ? 'âœ“' : ach.tier.toUpperCase()}
                                    </span>
                                </div>
                                <span class="achievement-desc">${ach.description}</span>
                            </div>
                            <div class="achievement-progress">
                                <div class="progress-bar-bg">
                                    <div class="progress-bar-fill" style="width: ${percent}%; background: ${tierColors[ach.tier]}"></div>
                                </div>
                                <span class="progress-text">${ach.progress} / ${ach.target}</span>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            function renderCauses(interests) {
                const causesContainer = document.getElementById('causesChips');
                if (!causesContainer) return;

                let causes = defaultCauses;
                if (interests && typeof interests === 'string' && interests.trim()) {
                    causes = interests.split(',').map(c => c.trim()).filter(c => c);
                    if (causes.length === 0) causes = defaultCauses;
                }

                causesContainer.innerHTML = causes.map(cause => `
                    <span class="cause-chip">${cause}</span>
                `).join('');
            }

            function setupProfileShare() {
                const shareBtn = document.getElementById('shareProfileBtn');
                if (!shareBtn) return;

                shareBtn.addEventListener('click', async () => {
                    const sharePayload = {
                        title: 'Actify Profile',
                        text: document.getElementById('profileWelcome')?.textContent || 'Check out my Actify profile!',
                        url: window.location.href
                    };

                    if (navigator.share) {
                        try {
                            await navigator.share(sharePayload);
                        } catch (error) {
                            console.warn('Share dismissed', error);
                        }
                    } else {
                        try {
                            await navigator.clipboard.writeText(sharePayload.url);
                            shareBtn.classList.add('shared');
                            shareBtn.textContent = 'Link copied!';
                            setTimeout(() => {
                                shareBtn.classList.remove('shared');
                                shareBtn.innerHTML = '<i data-lucide="share-2"></i> Share profile';
                                if (window.lucide) {
                                    window.lucide.createIcons();
                                }
                            }, 2000);
                        } catch (error) {
                            alert('Unable to copy link. Please copy it manually.');
                        }
                    }
                });
            }
        </script>
</body>

</html>
